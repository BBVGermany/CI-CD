name: Mirror All GitHub Repos to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:  # you run it manually, or add `schedule` for auto-sync

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Sync Repo
        uses: actions/checkout@v3

      - name: Install GitHub CLI & jq
        run: |
          sudo apt update
          sudo apt install gh jq -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GHP }}" | gh auth login --with-token

      - name: Get Repos and Mirror to Azure
        env:
          GITHUB_ORG: BBVGermany
          AZURE_ORG: ${{ secrets.ADO_ORG }}
          AZURE_PROJECT: ${{ secrets.ADO_PRO }}
          AZURE_PAT: ${{ secrets.AZURE_PAT }}
          GITHUB_TOKEN: ${{ secrets.GHP }}
        run: |
          echo "ðŸ“¥ Fetching repositories from GitHub org $GITHUB_ORG..."
          gh repo list "$GITHUB_ORG" --limit 1000 --json name | jq -r '.[].name' > repos.txt

          while read REPO; do
            echo "ðŸ”„ Syncing $REPO..."

            git clone --mirror "https://$GITHUB_TOKEN@github.com/$GITHUB_ORG/$REPO.git"
            cd "$REPO.git"

            git remote add azure "https://user:$AZURE_PAT@dev.azure.com/$AZURE_ORG/$AZURE_PROJECT/_git/$REPO"
            git push --mirror azure

            cd ..
            rm -rf "$REPO.git"
          done < repos.txt